Техническое Задание на разработку Telegram-бота для учета финансов
1. Общие сведения
Цель: Создать Telegram-бота для оперативного внесения транзакций (расходов и доходов) в существующую Google Таблицу.
Платформа: Google Apps Script (GAS).
Пользователи: Ограниченный круг лиц (White List по Telegram User ID).
2. Структура данных (Google Sheets)
Бот работает с двумя листами:
Лист "Транзакции" (существующий):
Блок "Расходы" (Столбцы A-D): Дата, Сумма, Описание, Категория.
Блок "Доходы" (Столбцы G-J): Дата, Сумма, Описание, Категория.
Лист "Settings" (новый, технический):
Используется для хранения справочника категорий и настроек.
Структура: Название категории | Тип (Доход/Расход) | ID юзеров (White List).
3. Функциональные требования
3.1. Интерфейс и Ввод данных
Команда /start: Приветствие.
Ввод данных: Пользователь отправляет текстовое сообщение в формате: Сумма Комментарий (например: 1500 такси до дома).
Парсинг: Первое число — сумма, остальная часть строки — описание.
Обработка ошибок: Если число не найдено, бот просит повторить ввод.
Выбор категории:
После ввода суммы бот отправляет сообщение с Inline-клавиатурой.
Кнопки формируются динамически на основе листа "Settings".
3.2. Логика обработки (Backend)
Авторизация: При получении любого сообщения сверять chat_id пользователя со списком разрешенных ID. Чужих игнорировать.
Маршрутизация:
При выборе категории бот определяет её тип (Доход или Расход) по справочнику.
Если Расход -> целевой диапазон столбцов A:D.
Если Доход -> целевой диапазон столбцов G:J.
Поиск места записи:
Скрипт сканирует только столбец с датами (A для расходов, G для доходов).
Находит первую строку, где ячейка пустая, начиная с 5-й строки (пропуск заголовков).
3.3. Запись данных (Database)
Concurrency Control: Использовать LockService для блокировки скрипта на время поиска строки и записи (во избежание коллизий при одновременном вводе).
Формат записи:
Дата: Текущая дата (dd.mm.yyyy).
Сумма: Числовой формат.
Описание: Текст из сообщения.
Категория: Текст выбранной кнопки.
4. Стек и инструменты
Язык: Google Apps Script (JavaScript).
API: Telegram Bot API (Webhooks).
Библиотеки GAS: SpreadsheetApp, LockService, UrlFetchApp.
TODO List (План реализации)
Этап 1: Подготовка окружения (Google Sheets)

Создать лист Settings.

Заполнить колонку A (Категории): Продукты, Сигареты, Зарплата...

Заполнить колонку B (Тип): expense, expense, income...

Заполнить колонку C (Users): ID мужа, ID жены.

Открыть редактор скриптов (Расширения -> Apps Script).
Этап 2: Регистрация Бота

BotFather: Создать нового бота, получить API_TOKEN.

BotFather: Установить описание и аватарку (опционально).

Сохранить токен в Script Properties проекта GAS (не хардкодить в коде).
Этап 3: Базовая логика бота (Code)

Написать функцию doPost(e):

Разбор JSON-пейлоада от Телеграма.

Проверка User ID по WhiteList (читаем из листа Settings).

Реализовать парсер сообщений:

Regex для выделения суммы и текста.

Сохранение временного состояния (Сумма и Описание) в CacheService или PropertiesService (ключ = user_id), чтобы ждать нажатия кнопки категории.

Реализовать отправку клавиатуры:

Функция чтения категорий из листа Settings.

Формирование JSON для Inline Keyboard.
Этап 4: Логика работы с Таблицей (Core)

Написать функцию findFirstEmptyRow(sheet, columnChar):

Чтение столбца массивом (getValues).

Цикл поиска null или "". Возврат индекса строки.

Написать функцию writeTransaction(data):

Инициализация LockService.getScriptLock().

try...catch блок.

Определение типа транзакции (Income/Expense) по категории.

Вызов поиска строки.

Запись данных (setValue).

Снятие блокировки.
Этап 5: Деплой и связка

Deploy Web App:

Execute as: Me.

Who has access: Anyone (нужно для Телеграма, но внутри кода у нас проверка ID).

Set Webhook:

Запустить разовую функцию setWebhook() с URL полученного веб-приложения.
Этап 6: Тестирование

Тест 1: Ввод текста (проверка парсера).

Тест 2: Нажатие кнопки (проверка записи).

Тест 3: Запись Расхода (проверка попадания в столбцы A-D).

Тест 4: Запись Дохода (проверка попадания в столбцы G-J).

Тест 5 (Стресс): Одновременная отправка сообщений с двух аккаунтов (проверка LockService).